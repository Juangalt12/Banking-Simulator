<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Bank Simulation</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #game { max-width: 900px; margin: auto; }
    h1, h2, h3 { color: #333; }
    label { display: block; margin: 10px 0; }
    input, select { width: 100px; margin-left: 10px; }
    #state, #decisions, #results, #charts {
      border: 1px dotted #ccc;
      padding: 15px;
      margin: 10px 0;
    }
    button { padding: 10px 20px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .section { margin-top: 20px; }
    canvas { margin-top: 20px; }
    .hack-scenario { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div id="game">
    <h1>Community Bank Simulation</h1>
    <div id="state">
      <h2>Month <span id="month">0</span></h2>
      <h3>Current Scenario: <span id="scenario" class="">Starting Out</span></h3>
      <p>Capital: <span id="capital">$10,000,000</span></p>
      <p>Deposits: <span id="deposits">$100,000,000</span></p>
      <p>Total Loans: <span id="totalLoans">$80,000,000</span></p>
      <p>Loan-to-Deposit Ratio: <span id="ldr">80.00</span>%</p>
      <p>Capital Adequacy Ratio (CAR): <span id="car">N/A</span>% (Regulatory Minimum: 10%)</p>
      <p>Efficiency Ratio: <span id="efficiency">N/A</span>%</p>
      <p>Federal Funds Rate: <span id="fedFundsRate">2.00</span>% (Change: <span id="fedFundsChange">0.00</span>%)</p>
      <p>Federal Funds Rate History (Last 12 Months): <span id="fedFundsHistory">2.00</span></p>
      <p><strong>Regulatory Lending Limit:</strong> Total loans cannot exceed 90% of deposits plus capital. Current limit: <span id="lendingLimit">$100,000,000</span></p>
      <p><strong>Staffing Costs Breakdown:</strong></p>
      <ul>
        <li>Branch Staff: <span id="branchStaffCost">$0</span> (Staff: <span id="branchStaffCount">0</span>)</li>
        <li>Residential Lending Staff: <span id="residentialLendingStaffCost">$0</span> (Staff: <span id="residentialLendingStaffCount">0</span>)</li>
        <li>Commercial Lending Staff: <span id="commercialLendingStaffCost">$0</span> (Staff: <span id="commercialLendingStaffCount">0</span>)</li>
        <li>Small Business Lending Staff: <span id="smallBusinessLendingStaffCost">$0</span> (Staff: <span id="smallBusinessLendingStaffCount">0</span>)</li>
        <li>Technology Staff: <span id="techStaffCost">$0</span> (Staff: <span id="techStaffCount">0</span>)</li>
        <li>HR Staff: <span id="hrStaffCost">$0</span> (Staff: <span id="hrStaffCount">0</span>)</li>
        <li>Compliance Staff: <span id="complianceStaffCost">$0</span> (Staff: <span id="complianceStaffCount">0</span>)</li>
        <li>Executives: <span id="executivesCost">$0</span> (Staff: <span id="executivesCount">0</span>)</li>
        <li>CEO: <span id="ceoCost">$0</span> (Staff: <span id="ceoCount">0</span>)</li>
        <li>Sales Staff: <span id="salesStaffCost">$0</span> (Staff: <span id="salesStaffCount">0</span>)</li>
        <li><strong>Total Staffing Costs: <span id="totalStaffingCosts">$0</span></strong></li>
        <li><strong>Total Staff: <span id="totalStaffCount">0</span></strong></li>
      </ul>
      <h3>Current Loan Demand ($M)</h3>
      <p>Residential Mortgages: <span id="demandResidentialMortgages">10.00</span></p>
      <p>Commercial Real Estate: <span id="demandCommercialRealEstate">7.00</span></p>
      <p>Small Business Loans: <span id="demandSmallBusinessLoans">5.00</span></p>
      <h3>Loan Activity ($M)</h3>
      <p>New Loans: <span id="newLoans">0.00</span></p>
      <p>Loan Runoff: <span id="loanRunoff">0.00</span></p>
      <p>Net Loan Change: <span id="netLoanChange">0.00</span></p>
    </div>
    <form id="decisions">
      <div class="section">
        <h3>Decisions for Next Month</h3>
        <label>Deposit Interest Rate (%): <input type="number" step="0.1" id="depositRate" value="2.0" min="0"></label>
      </div>
      <div class="section">
        <h4>Loan Interest Rates (%)</h4>
        <label>Residential Mortgages: <input type="number" step="0.1" id="rateResidentialMortgages" value="4.5" min="0"> <span id="marginResidentialMortgages"></span></label>
        <label>Commercial Real Estate: <input type="number" step="0.1" id="rateCommercialRealEstate" value="5.5" min="0"> <span id="marginCommercialRealEstate"></span></label>
        <label>Small Business Loans: <input type="number" step="0.1" id="rateSmallBusinessLoans" value="7.0" min="0"> <span id="marginSmallBusinessLoans"></span></label>
      </div>
      <div class="section">
        <label>Sales Staff (Salary $6,000/month each, increases loan demand by 0.5% per staff, +0.5% annual deposit growth, reduces runoff): <input type="number" id="salesStaff" value="7" min="1"></label>
        <label>Technology Package: 
          <select id="techPackage">
            <option value="basic">Basic ($1,010/month, no bonus)</option>
            <option value="standard">Standard ($3,010/month, +10% staff effectiveness)</option>
            <option value="advanced">Advanced ($5,010/month, +20% staff effectiveness)</option>
          </select>
        </label>
        <label>Advertising Budget ($/month, increases loan demand): <input type="number" id="advertisingBudget" value="0" min="0" max="50000"></label>
        <p>Advertising increases loan demand by 0.5% per $1,000 spent monthly (e.g., $10,000 increases demand by 5%). Budget capped at $50,000.</p>
      </div>
      <button type="submit">Submit Decisions</button>
    </form>
    <div id="results" style="display:none">
      <h3>Monthly Results</h3>
      <p>Interest Income: <span id="interestIncome">$0</span></p>
      <p>Interest Expense: <span id="interestExpense">$0</span></p>
      <p>Non-Interest Expenses: <span id="nonInterestExpenses">$0</span></p>
      <p>Loan Losses: <span id="loanLosses">$0</span></p>
      <p>Net Profit: <span id="netProfit">$0</span></p>
      <p><strong>Efficiency Ratio Explanation:</strong> The efficiency ratio is calculated as Non-Interest Expenses / Interest Income. A lower ratio indicates better cost management relative to income.</p>
    </div>
    <div id="charts">
      <canvas id="chart" width="400" height="200"></canvas>
      <canvas id="fedFundsChart" width="400" height="200"></canvas>
    </div>
  </div>
  <script>
    // Define loan types with initial demand
    const loanTypes = [
      { name: 'Residential Mortgages', marketRate: 4.5, defaultRate: 0.5, riskWeight: 50, term: 360, initialDemand: 10000000 },
      { name: 'Commercial Real Estate', marketRate: 5.5, defaultRate: 1.0, riskWeight: 100, term: 120, initialDemand: 7000000 },
      { name: 'Small Business Loans', marketRate: 7.0, defaultRate: 2.0, riskWeight: 100, term: 60, initialDemand: 5000000 },
    ];

    // Define technology multipliers and updated costs
    const techMultipliers = { basic: 1.0, standard: 1.1, advanced: 1.2 };
    const techCosts = { basic: 1010, standard: 3010, advanced: 5010 };

    // Define scenarios with increased federal funds rate variability
    const scenarios = [
      { name: 'Economic Boom', loanDemandChange: { all: 10 }, depositGrowthBase: 5, interestRateChange: 0, defaultMultiplier: 0.8 },
      { name: 'Recession', loanDemandChange: { all: -15 }, depositGrowthBase: 10, interestRateChange: -2.5, defaultMultiplier: 1.5 },
      { name: 'Inflation Spike', loanDemandChange: { all: 5 }, depositGrowthBase: -5, interestRateChange: 3.0, defaultMultiplier: 1.0 },
      { name: 'Geopolitical Crisis', loanDemandChange: { all: -10 }, depositGrowthBase: 15, interestRateChange: 1.5, defaultMultiplier: 1.2 },
      { name: 'Natural Disaster', loanDemandChange: { 'Commercial Real Estate': 20, all: 0 }, depositGrowthBase: 0, interestRateChange: 0, defaultMultiplier: 1.0 },
      { name: 'Tech Boom', loanDemandChange: { 'Small Business Loans': 25, all: 0 }, depositGrowthBase: 10, interestRateChange: 0.5, defaultMultiplier: 0.9 },
      { name: 'Housing Market Crash', loanDemandChange: { 'Residential Mortgages': -20, all: 0 }, depositGrowthBase: 5, interestRateChange: -1.5, defaultMultiplier: 1.3 },
      { name: 'Energy Crisis', loanDemandChange: { 'Commercial Real Estate': 15, all: 0 }, depositGrowthBase: 0, interestRateChange: 1.0, defaultMultiplier: 1.1 },
      { name: 'Pandemic', loanDemandChange: { all: -20 }, depositGrowthBase: 10, interestRateChange: -2.0, defaultMultiplier: 1.4 },
      { name: 'Regulatory Changes', loanDemandChange: { all: 0 }, depositGrowthBase: 0, interestRateChange: 0, defaultMultiplier: 1.0 },
    ];

    // Define hack scenario
    const hackScenario = {
      name: 'The Bank Has Been Hacked!',
      loanDemandChange: { all: -20 },
      depositGrowthBase: 0,
      interestRateChange: 0,
      defaultMultiplier: 1.0,
    };

    // Initial bank state
    let bank = {
      month: 0,
      capital: 10000000,
      deposits: 100000000,
      loanPortfolio: [],
      staffing: {
        branch: 5,
        residentialLending: 4,
        commercialLending: 2,
        smallBusinessLending: 2,
        tech: 3,
        hr: 2,
        compliance: 2,
        executives: 3,
        ceo: 1,
        sales: 7
      },
      technology: 'basic',
      marketDepositRate: 2.0,
      marketLoanRates: loanTypes.map(lt => lt.marketRate),
      fedFundsRate: 2.0,
      fedFundsRateHistory: [2.0],
      fullFedFundsHistory: [2.0],
      newLoans: 0,
      loanRunoff: 0,
      netLoanChange: 0,
      currentDemand: [10000000, 7000000, 5000000],
      totalStaffingCosts: 0,
      totalLoansHistory: [],
      efficiencyRatioHistory: [],
      hackTriggered: false,
      hackEffect: 0,
    };

    // Start with $80M in outstanding loans
    bank.loanPortfolio = [
      { type: 'Residential Mortgages', originationMonth: -12, initialBalance: 40000000, currentBalance: 38000000, rate: 4.5, term: 360, remainingTerm: 348, payment: calculatePayment(40000000, 4.5, 360) },
      { type: 'Commercial Real Estate', originationMonth: -6, initialBalance: 20000000, currentBalance: 19000000, rate: 5.5, term: 120, remainingTerm: 114, payment: calculatePayment(20000000, 5.5, 120) },
      { type: 'Small Business Loans', originationMonth: -3, initialBalance: 20000000, currentBalance: 19500000, rate: 7.0, term: 60, remainingTerm: 57, payment: calculatePayment(20000000, 7.0, 60) },
    ];

    // Calculate monthly loan payment
    function calculatePayment(balance, rate, term) {
      const monthlyRate = rate / 100 / 12;
      return monthlyRate === 0 ? balance / term : balance * monthlyRate / (1 - Math.pow(1 + monthlyRate, -term));
    }

    // Format currency without decimals
    function formatCurrency(value) {
      return value.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // Update demand display dynamically
    function updateDemandDisplay() {
      const loanRates = loanTypes.map(lt => parseFloat(document.getElementById(`rate${lt.name.replace(/\s/g, '')}`).value));
      const advertisingBudget = parseFloat(document.getElementById('advertisingBudget').value);
      const salesStaff = parseInt(document.getElementById('salesStaff').value);
      const demandMultiplier = 1 + (advertisingBudget / 1000) * 0.005 + salesStaff * 0.005; // 0.5% per $1,000 and per staff
      const demands = loanTypes.map((lt, i) => {
        const baseDemand = lt.initialDemand;
        const rateEffect = 1 - (loanRates[i] - bank.marketLoanRates[i]) * 0.2;
        return Math.max(0, baseDemand * rateEffect * demandMultiplier);
      });
      document.getElementById('demandResidentialMortgages').textContent = (demands[0] / 1000000).toFixed(2);
      document.getElementById('demandCommercialRealEstate').textContent = (demands[1] / 1000000).toFixed(2);
      document.getElementById('demandSmallBusinessLoans').textContent = (demands[2] / 1000000).toFixed(2);
    }

    // Update margins dynamically
    const depositRateInput = document.getElementById('depositRate');
    const loanRateInputs = loanTypes.map(lt => document.getElementById(`rate${lt.name.replace(/\s/g, '')}`));
    const lendingLimitSpan = document.getElementById('lendingLimit');
    const totalStaffingCostsSpan = document.getElementById('totalStaffingCosts');
    const branchStaffCostSpan = document.getElementById('branchStaffCost');
    const residentialLendingStaffCostSpan = document.getElementById('residentialLendingStaffCost');
    const commercialLendingStaffCostSpan = document.getElementById('commercialLendingStaffCost');
    const smallBusinessLendingStaffCostSpan = document.getElementById('smallBusinessLendingStaffCost');
    const techStaffCostSpan = document.getElementById('techStaffCost');
    const hrStaffCostSpan = document.getElementById('hrStaffCost');
    const complianceStaffCostSpan = document.getElementById('complianceStaffCost');
    const executivesCostSpan = document.getElementById('executivesCost');
    const ceoCostSpan = document.getElementById('ceoCost');
    const salesStaffCostSpan = document.getElementById('salesStaffCost');
    const branchStaffCountSpan = document.getElementById('branchStaffCount');
    const residentialLendingStaffCountSpan = document.getElementById('residentialLendingStaffCount');
    const commercialLendingStaffCountSpan = document.getElementById('commercialLendingStaffCount');
    const smallBusinessLendingStaffCountSpan = document.getElementById('smallBusinessLendingStaffCount');
    const techStaffCountSpan = document.getElementById('techStaffCount');
    const hrStaffCountSpan = document.getElementById('hrStaffCount');
    const complianceStaffCountSpan = document.getElementById('complianceStaffCount');
    const executivesCountSpan = document.getElementById('executivesCount');
    const ceoCountSpan = document.getElementById('ceoCount');
    const salesStaffCountSpan = document.getElementById('salesStaffCount');
    const totalStaffCountSpan = document.getElementById('totalStaffCount');

    function updateMargins() {
      const depositRate = parseFloat(depositRateInput.value);
      loanRateInputs.forEach((input, i) => {
        const loanRate = parseFloat(input.value);
        const margin = loanRate - depositRate;
        let comment = margin > 3 ? 'Very Good' : margin > 2 ? 'Good' : 'Low Margin';
        document.getElementById(`margin${loanTypes[i].name.replace(/\s/g, '')}`).textContent = `(Margin: ${margin.toFixed(2)}% - ${comment})`;
      });
    }

    // Update lending limit display
    function updateLendingLimitDisplay() {
      const lendingLimit = bank.deposits * 0.9 + bank.capital;
      lendingLimitSpan.textContent = formatCurrency(lendingLimit);
    }

    // Update staffing
    function updateStaffing() {
      bank.staffing.branch = Math.ceil(bank.deposits / 20000000); // 1 per $20M deposits
      const residentialPortfolio = bank.loanPortfolio.filter(c => c.type === 'Residential Mortgages').reduce((s, c) => s + c.currentBalance, 0);
      bank.staffing.residentialLending = Math.ceil(Math.max(bank.currentDemand[0], residentialPortfolio) / 10000000); // 1 per $10M
      const commercialPortfolio = bank.loanPortfolio.filter(c => c.type === 'Commercial Real Estate').reduce((s, c) => s + c.currentBalance, 0);
      bank.staffing.commercialLending = Math.ceil(Math.max(bank.currentDemand[1], commercialPortfolio) / 10000000); // 1 per $10M
      const smallBusinessPortfolio = bank.loanPortfolio.filter(c => c.type === 'Small Business Loans').reduce((s, c) => s + c.currentBalance, 0);
      bank.staffing.smallBusinessLending = Math.ceil(Math.max(bank.currentDemand[2], smallBusinessPortfolio) / 10000000); // 1 per $10M
      bank.staffing.tech = 3;
      const totalEmployees = bank.staffing.branch + bank.staffing.residentialLending + bank.staffing.commercialLending + 
                            bank.staffing.smallBusinessLending + bank.staffing.tech + bank.staffing.compliance + 
                            bank.staffing.executives + bank.staffing.ceo + bank.staffing.sales;
      bank.staffing.hr = Math.ceil(totalEmployees / 15); // 1 per 15 employees
      bank.staffing.compliance = 2;
      bank.staffing.executives = 3;
      bank.staffing.ceo = 1;
    }

    // Update staffing costs display
    function updateStaffingCostsDisplay() {
      const branchStaffCost = bank.staffing.branch * 4000;
      const residentialLendingStaffCost = bank.staffing.residentialLending * 6000;
      const commercialLendingStaffCost = bank.staffing.commercialLending * 6000;
      const smallBusinessLendingStaffCost = bank.staffing.smallBusinessLending * 6000;
      const salesStaffCost = bank.staffing.sales * 6000;
      const techStaffCost = bank.staffing.tech * 8000;
      const hrStaffCost = bank.staffing.hr * 5000;
      const complianceStaffCost = bank.staffing.compliance * 7000;
      const executivesCost = bank.staffing.executives * 10000;
      const ceoCost = bank.staffing.ceo * 20000;
      bank.totalStaffingCosts = branchStaffCost + residentialLendingStaffCost + commercialLendingStaffCost + smallBusinessLendingStaffCost + 
                                salesStaffCost + techStaffCost + hrStaffCost + complianceStaffCost + executivesCost + ceoCost;
      
      branchStaffCostSpan.textContent = formatCurrency(branchStaffCost);
      residentialLendingStaffCostSpan.textContent = formatCurrency(residentialLendingStaffCost);
      commercialLendingStaffCostSpan.textContent = formatCurrency(commercialLendingStaffCost);
      smallBusinessLendingStaffCostSpan.textContent = formatCurrency(smallBusinessLendingStaffCost);
      techStaffCostSpan.textContent = formatCurrency(techStaffCost);
      hrStaffCostSpan.textContent = formatCurrency(hrStaffCost);
      complianceStaffCostSpan.textContent = formatCurrency(complianceStaffCost);
      executivesCostSpan.textContent = formatCurrency(executivesCost);
      ceoCostSpan.textContent = formatCurrency(ceoCost);
      salesStaffCostSpan.textContent = formatCurrency(salesStaffCost);
      totalStaffingCostsSpan.textContent = formatCurrency(bank.totalStaffingCosts);

      branchStaffCountSpan.textContent = bank.staffing.branch;
      residentialLendingStaffCountSpan.textContent = bank.staffing.residentialLending;
      commercialLendingStaffCountSpan.textContent = bank.staffing.commercialLending;
      smallBusinessLendingStaffCountSpan.textContent = bank.staffing.smallBusinessLending;
      techStaffCountSpan.textContent = bank.staffing.tech;
      hrStaffCountSpan.textContent = bank.staffing.hr;
      complianceStaffCountSpan.textContent = bank.staffing.compliance;
      executivesCountSpan.textContent = bank.staffing.executives;
      ceoCountSpan.textContent = bank.staffing.ceo;
      salesStaffCountSpan.textContent = bank.staffing.sales;
      
      const totalStaff = bank.staffing.branch + bank.staffing.residentialLending + bank.staffing.commercialLending + 
                         bank.staffing.smallBusinessLending + bank.staffing.tech + bank.staffing.hr + 
                         bank.staffing.compliance + bank.staffing.executives + bank.staffing.ceo + bank.staffing.sales;
      totalStaffCountSpan.textContent = totalStaff;
    }

    // Update display
    function updateDisplay() {
      updateStaffing();
      const totalLoansValue = totalLoans();
      const rwa = loanTypes.reduce((sum, lt) => {
        const typeBalance = bank.loanPortfolio.filter(c => c.type === lt.name).reduce((s, c) => s + c.currentBalance, 0);
        return sum + typeBalance * (lt.riskWeight / 100);
      }, 0);
      const car = rwa > 0 ? (bank.capital / rwa) * 100 : 100;
      const ldr = bank.deposits > 0 ? (totalLoansValue / bank.deposits) * 100 : 0;
      const lendingLimit = bank.deposits * 0.9 + bank.capital;

      document.getElementById('month').textContent = bank.month;
      document.getElementById('scenario').textContent = bank.currentScenario ? bank.currentScenario.name : 'Starting Out';
      if (bank.currentScenario === hackScenario) {
        document.getElementById('scenario').classList.add('hack-scenario');
      } else {
        document.getElementById('scenario').classList.remove('hack-scenario');
      }
      document.getElementById('capital').textContent = formatCurrency(bank.capital);
      document.getElementById('deposits').textContent = formatCurrency(bank.deposits);
      document.getElementById('totalLoans').textContent = formatCurrency(totalLoansValue);
      document.getElementById('ldr').textContent = ldr.toFixed(2);
      document.getElementById('car').textContent = car.toFixed(2);
      document.getElementById('efficiency').textContent = bank.lastInterestIncome > 0 ? (bank.lastNonInterestExpenses / bank.lastInterestIncome * 100).toFixed(2) : 'N/A';
      document.getElementById('fedFundsRate').textContent = bank.fedFundsRate.toFixed(2);
      const change = bank.month > 0 ? (bank.fedFundsRate - bank.fedFundsRateHistory[bank.fedFundsRateHistory.length - 2]).toFixed(2) : 0;
      document.getElementById('fedFundsChange').textContent = change;
      document.getElementById('fedFundsHistory').textContent = bank.fedFundsRateHistory.map(rate => rate.toFixed(2)).join(', ');
      document.getElementById('newLoans').textContent = (bank.newLoans / 1000000).toFixed(2);
      document.getElementById('loanRunoff').textContent = (bank.loanRunoff / 1000000).toFixed(2);
      document.getElementById('netLoanChange').textContent = (bank.netLoanChange / 1000000).toFixed(2);
      lendingLimitSpan.textContent = formatCurrency(lendingLimit);
      updateStaffingCostsDisplay();
    }

    // Total loans helper
    function totalLoans() {
      return bank.loanPortfolio.reduce((sum, cohort) => sum + cohort.currentBalance, 0);
    }

    // Update charts
    const chartCtx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Total Loans ($M)', data: [], borderColor: 'blue', yAxisID: 'y1' },
          { label: 'Efficiency Ratio (%)', data: [], borderColor: 'red', yAxisID: 'y2' },
        ],
      },
      options: {
        scales: {
          y1: { position: 'left', title: { display: true, text: 'Total Loans ($M)' } },
          y2: { position: 'right', title: { display: true, text: 'Efficiency Ratio (%)' } }
        }
      },
    });

    const fedFundsChartCtx = document.getElementById('fedFundsChart').getContext('2d');
    const fedFundsChart = new Chart(fedFundsChartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{ label: 'Federal Funds Rate (%)', data: [], borderColor: 'green' }],
      },
      options: {
        scales: { y: { title: { display: true, text: 'Federal Funds Rate (%)' } } }
      },
    });

    function updateChart() {
      chart.data.labels.push(`Month ${bank.month}`);
      chart.data.datasets[0].data.push(totalLoans() / 1000000);
      chart.data.datasets[1].data.push(bank.lastInterestIncome > 0 ? (bank.lastNonInterestExpenses / bank.lastInterestIncome * 100) : 0);
      chart.update();

      fedFundsChart.data.labels = Array.from({length: bank.month + 1}, (_, i) => `Month ${i}`);
      fedFundsChart.data.datasets[0].data = bank.fullFedFundsHistory;
      fedFundsChart.update();
    }

    // Advance month
    function advanceMonth(event) {
      event.preventDefault();

      // Select scenario with hack logic
      let scenario;
      if (bank.hackEffect > 0) {
        scenario = hackScenario;
        bank.hackEffect -= 1;
      } else if (!bank.hackTriggered && bank.month >= 5 && bank.month <= 40 && Math.random() < 0.1) {
        bank.hackTriggered = true;
        bank.hackEffect = 2; // Affects this month and next
        scenario = hackScenario;
      } else {
        scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
      }
      bank.currentScenario = scenario;

      // Update federal funds rate
      bank.fedFundsRate += scenario.interestRateChange || 0;
      bank.fedFundsRate = Math.max(0, bank.fedFundsRate);
      bank.fedFundsRateHistory.push(bank.fedFundsRate);
      bank.fullFedFundsHistory.push(bank.fedFundsRate);
      if (bank.fedFundsRateHistory.length > 12) bank.fedFundsRateHistory.shift();

      // Adjust market rates
      bank.marketDepositRate = Math.max(0, bank.marketDepositRate + (scenario.interestRateChange || 0));
      bank.marketLoanRates = bank.marketLoanRates.map(rate => Math.max(0, rate + (scenario.interestRateChange || 0)));

      // Get decisions
      const depositRate = parseFloat(document.getElementById('depositRate').value);
      const loanRates = loanTypes.map(lt => parseFloat(document.getElementById(`rate${lt.name.replace(/\s/g, '')}`).value));
      const salesStaff = parseInt(document.getElementById('salesStaff').value);
      const techPackage = document.getElementById('techPackage').value;
      const advertisingBudget = parseFloat(document.getElementById('advertisingBudget').value);

      bank.staffing.sales = salesStaff;
      bank.technology = techPackage;

      // Calculate deposit growth
      const multiplier = techMultipliers[bank.technology];
      let annualDepositGrowth = scenario.depositGrowthBase + (depositRate - bank.marketDepositRate) * 10 + (bank.staffing.sales * 0.5 * multiplier);
      if (scenario === hackScenario) annualDepositGrowth *= 0.8; // 20% reduction during hack
      bank.deposits *= (1 + annualDepositGrowth / 100 / 12);

      // Calculate loan runoff rate with interest rate impact
      const baseRunoffRate = 0.005;
      const fedFundsChange = bank.month > 0 ? bank.fedFundsRate - bank.fedFundsRateHistory[bank.fedFundsRateHistory.length - 2] : 0;
      const runoffIncrease = Math.max(0, -fedFundsChange * 0.001);
      const runoffRate = baseRunoffRate * (1 - (bank.staffing.sales * 0.01 * multiplier)) + runoffIncrease;
      bank.loanRunoff = bank.loanPortfolio.reduce((sum, cohort) => sum + cohort.currentBalance * runoffRate, 0);

      // Calculate actual loan demand with scenario effects and boosts
      const demandChanges = scenario.loanDemandChange;
      const demandMultiplier = 1 + (advertisingBudget / 1000) * 0.005 + salesStaff * 0.005; // 0.5% per $1,000 and per staff
      const loanDemands = loanTypes.map((lt, i) => {
        const baseDemand = lt.initialDemand;
        const change = demandChanges[lt.name] !== undefined ? demandChanges[lt.name] : (demandChanges.all || 0);
        const rateEffect = 1 - (loanRates[i] - bank.marketLoanRates[i]) * 0.2;
        return Math.max(0, baseDemand * (1 + change / 100) * rateEffect * demandMultiplier);
      });
      bank.currentDemand = loanDemands;

      // Calculate loan originations automatically
      const totalCapacity = bank.staffing.sales * 5000000 * techMultipliers[bank.technology];
      const capacityPerType = totalCapacity / loanTypes.length;
      const currentLoans = totalLoans();
      const lendingLimit = bank.deposits * 0.9 + bank.capital;
      const availableLending = lendingLimit - currentLoans;

      let totalPotential = 0;
      const potentialOriginations = loanDemands.map(demand => Math.min(demand, capacityPerType));
      totalPotential = potentialOriginations.reduce((sum, po) => sum + po, 0);

      const scaleFactor = totalPotential > 0 ? Math.min(1, availableLending / totalPotential) : 0;
      bank.newLoans = 0;

      loanTypes.forEach((lt, i) => {
        const origination = potentialOriginations[i] * scaleFactor;
        if (origination > 0) {
          bank.loanPortfolio.push({
            type: lt.name,
            originationMonth: bank.month,
            initialBalance: origination,
            currentBalance: origination,
            rate: loanRates[i],
            term: lt.term,
            remainingTerm: lt.term,
            payment: calculatePayment(origination, loanRates[i], lt.term),
          });
          bank.newLoans += origination;
        }
      });

      // Process loan portfolio
      let interestIncome = 0;
      let principalRepayments = 0;
      let totalLosses = 0;
      const defaultMultiplier = scenario.defaultMultiplier || 1;
      bank.loanPortfolio = bank.loanPortfolio.filter(cohort => cohort.remainingTerm > 0);
      bank.loanPortfolio.forEach(cohort => {
        const lt = loanTypes.find(t => t.name === cohort.type);
        const loss = cohort.currentBalance * (lt.defaultRate / 100 * defaultMultiplier / 12) * 0.5;
        totalLosses += loss;
        cohort.currentBalance -= loss;

        const payment = cohort.payment;
        const interest = cohort.currentBalance * (cohort.rate / 100 / 12);
        const principal = Math.min(payment - interest, cohort.currentBalance);
        interestIncome += interest;
        principalRepayments += principal;
        cohort.currentBalance -= principal;
        cohort.remainingTerm -= 1;
      });

      // Apply runoff
      bank.loanPortfolio.forEach(cohort => {
        const runoffAmount = cohort.currentBalance * runoffRate;
        cohort.currentBalance -= runoffAmount;
        bank.capital += runoffAmount;
      });

      // Update net loan change
      bank.netLoanChange = bank.newLoans - bank.loanRunoff;

      // Deduct losses from capital
      bank.capital -= totalLosses;

      // Calculate expenses
      const interestExpense = bank.deposits * (depositRate / 100 / 12);
      const salaryCost = bank.totalStaffingCosts;
      const nonInterestExpenses = salaryCost + techCosts[bank.technology] + advertisingBudget;

      // Calculate profit
      const revenue = interestIncome;
      const expenses = interestExpense + nonInterestExpenses + totalLosses;
      const netProfit = revenue - expenses;
      bank.capital += netProfit;

      // Store for ratios
      bank.lastInterestIncome = interestIncome;
      bank.lastNonInterestExpenses = nonInterestExpenses;

      // Check compliance
      const rwa = loanTypes.reduce((sum, lt) => {
        const typeBalance = bank.loanPortfolio.filter(c => c.type === lt.name).reduce((s, c) => s + c.currentBalance, 0);
        return sum + typeBalance * (lt.riskWeight / 100);
      }, 0);
      const car = rwa > 0 ? (bank.capital / rwa) * 100 : 100;
      if (car < 10) {
        alert('Warning: CAR below 10%. Regulatory action may be required.');
      }

      // Update results
      document.getElementById('interestIncome').textContent = formatCurrency(interestIncome);
      document.getElementById('interestExpense').textContent = formatCurrency(interestExpense);
      document.getElementById('nonInterestExpenses').textContent = formatCurrency(nonInterestExpenses);
      document.getElementById('loanLosses').textContent = formatCurrency(totalLosses);
      document.getElementById('netProfit').textContent = formatCurrency(netProfit);
      document.getElementById('results').style.display = 'block';

      // Advance month
      bank.month += 1;
      updateDisplay();
      updateMargins();
      updateDemandDisplay();
      updateLendingLimitDisplay();
      updateChart();

      if (bank.month >= 48) {
        alert(`Simulation Complete!\nFinal Capital: ${formatCurrency(bank.capital)}\nFinal CAR: ${car.toFixed(2)}%\nEfficiency Ratio: ${(nonInterestExpenses / revenue * 100).toFixed(2)}%`);
        document.querySelector('#decisions button').disabled = true;
      }
    }

    // Initialize game
    document.getElementById('decisions').addEventListener('submit', advanceMonth);
    depositRateInput.addEventListener('input', updateMargins);
    loanRateInputs.forEach(input => input.addEventListener('input', () => {
      updateMargins();
      updateDemandDisplay();
    }));
    document.getElementById('advertisingBudget').addEventListener('input', updateDemandDisplay);
    document.getElementById('salesStaff').addEventListener('input', updateDemandDisplay);
    updateDisplay();
    updateMargins();
    updateDemandDisplay();
    updateLendingLimitDisplay();
    updateChart();
  </script>
</body>
</html>
